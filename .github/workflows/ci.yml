name: CI

on:
  push:
#    branches: [ master ]
#  pull_request:
#    branches: [ master ]

jobs:
  integration:
    strategy:
      fail-fast: false
      matrix:
        platform: [ios, macos, android]
        include:
          - platform: ios
            os: macos-latest
          - platform: macos
            os: macos-latest
          - platform: android
            os: macos-latest

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v2
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      ## iOS integration
      - name: Start up iOS Simulator
        if: ${{ matrix.platform == 'ios' }}
        uses: futureware-tech/simulator-action@v1
        with:
          model: 'iPhone 8'

      ## macOS integration
      - name: Enable desktop support
        if: ${{ matrix.platform == 'macos' }}
        run: flutter config --enable-macos-desktop

      - name: Run Flutter Doctor
        run: flutter doctor
      - name: Install dependencies
        run: flutter pub get

      - name: Run tests
        if: ${{ matrix.platform != 'android' }}
        working-directory: ./example
        run: flutter test integration_test

      ## Android integration
      - name: Run tests on Android Emulator
        if: ${{ matrix.platform == 'android' }}
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          working-directory: ./example
          script: flutter test integration_test